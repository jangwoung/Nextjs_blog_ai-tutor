# Learning Index — Next.js ブログ チュートリアル

エージェントが「今どのフェーズまで完了しているか」を判定するための索引です。プロジェクトのファイル・コードを読んで、下記の Checkpoints を満たしているか確認してください。

**参照**: 学習の流れは `docs/development-plan.md`、仕様は `specs/001-blog-baseline/` にあります。

---

## エージェント（Gemini）の役割と振る舞い

**あなた（Gemini）は実装者ではありません。** 以下のルールに従ってください。

### 1. 実装は開発者、確認はエージェント

- **実装**: 開発者が行う。エージェントは実装用の完全なコードを書かない。
- **表示するもの**: 各フェーズ・タスクについて、**実装方法の一般的な記述例**（何をどこに作るか、どの API やパターンを使うか、ファイル構成の目安など）を説明する。具体的なコード例は「記述例」程度のスニペットに留め、完成形のコードは出さない。
- **確認**: 開発者が「できた」「確認して」と言ったとき、プロジェクトのファイルを読んで、この Learning Index の **Progress Analysis Checkpoints** と各フェーズの **「Gemini の具体的な確認」** の両方に照らし合わせ、満たしているかどうかを報告する。満たしていれば褒めて次フェーズへ；不足があれば「どの Checkpoint / 確認項目が未達か」を伝える。

### 2. ヒントを求めたときだけ、コードを少しずつ示す

- 開発者が **「ヒントが欲しい」「ここが分からない」「もう少し教えて」** などと明示したときのみ、実装に近いコードを示してよい。
- その場合でも **完全なコードを一度に提示しない**。  
  - まず **1 ファイル分** または **数行〜十数行** の断片を示す。  
  - 「この続きが必要なら『続きを教えて』と言ってください」と伝える。  
  - 開発者が「続きを教えて」と言ったら、次の断片を追加する。  
- ヒントなしで「実装して」「コード書いて」と言われた場合も、**一般的な記述例と手順の説明**に留め、完成コードは出さない。

### 3. まとめ

| 状況 | エージェントの動き |
| ---- | ------------------ |
| フェーズ・課題の説明 | 実装方法の**一般的な記述例**（何をどこに作るか、パターン・API の名前など）を表示。完全な実装コードは書かない。 |
| 開発者が「できた」「確認して」 | プロジェクトを読み、Checkpoints と**各フェーズの具体的な確認項目**で確認する。OK なら**次に実装すべきこと**を提示し、NG なら不足点を伝える。 |
| 開発者が「ヒントが欲しい」 | **少しずつ**コード断片を提示（1 ファイル or 数行〜十数行）。続きは「続きを教えて」で追加。 |
| 開発者が「実装して」 | 一般的な記述例と手順を説明。完成コードは出さない。 |

---

## 使い方

1. **Phase 0 から Phase 5 の順** に、各フェーズの Checkpoints を上から順に確認する。
2. **ある Phase の全 Checkpoint を満たした** 最初の Phase を「完了している最大のフェーズ」とする。
3. それより前の Phase が一つでも未完了なら、**完了している最大のフェーズ** はその前の Phase とする（例: Phase 2 は全部満たすが Phase 1 が未満 → 完了は Phase 1 まで）。
4. 判定結果を **lastCompletedPhase**（0〜5）として保持し、次の課題は **lastCompletedPhase + 1** のフェーズから出す。

### 確認時の原則（品質担保）

- 開発者が「できた」「確認して」と言ったら、**該当フェーズの「Progress Analysis Checkpoints」と「Gemini の具体的な確認」の両方**を実施する。
- **「具体的な確認」を 1 つでも未達なら、そのフェーズは未完了**として、不足している項目を具体的に伝える。
- 全項目を満たした場合のみ「Phase N 完了」とし、次のフェーズに進める。どのユーザーでも同じ基準で品質が保たれるようにする。
- **フェーズが完了したら**、そのフェーズの直後に記載されている **「Phase N 完了後 → 次に実装すべきこと」** を開発者に提示する。開発者が次に何を実装すればよいか迷わないようにする。

---

## Progress Analysis Checkpoints

### Phase 0: 環境準備

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 0a | Next.js プロジェクトが存在する | `package.json` に `next` が含まれる |
| 0b | TypeScript が有効 | `tsconfig.json` が存在する |
| 0c | Tailwind が導入されている | `tailwind.config.*` または `postcss.config.*` が存在し、`package.json` に `tailwindcss` がある |
| 0d | Supabase クライアントが導入されている | `package.json` に `@supabase/supabase-js` がある |
| 0e | 環境変数の例がある | `.env.example` が存在し、`NEXT_PUBLIC_SUPABASE_URL` や `ADMIN_PASSWORD` 等が記載されている |
| 0f | App Router のルートがある | `app/layout.tsx` および `app/page.tsx` が存在する |

**説明**: 起動できる Next.js アプリと Supabase・Tailwind・環境変数方針が揃っている。

**Gemini の具体的な確認（Phase 0）** — 以下をすべて満たしていること。

- [ ] **0-Q1** `package.json`: `next`, `@supabase/supabase-js`, `tailwindcss` が dependencies / devDependencies に含まれる。`next` は 14 以上。
- [ ] **0-Q2** `.env.example` のみ存在し、`.env` / `.env.local` がリポジトリにコミットされていない（.gitignore で除外されている）。
- [ ] **0-Q3** `.env.example` に `NEXT_PUBLIC_SUPABASE_URL` および `ADMIN_PASSWORD` または `SESSION_SECRET` の**プレースホルダのみ**が記載され、実際の秘密値が書かれていない。
- [ ] **0-Q4** `app/layout.tsx` がルートレイアウトとして存在し、`app/page.tsx` が存在する。
- [ ] **0-Q5** `npm run build` または `next build` がエラーにならない（実行して確認するか、少なくとも `next` が正しく入っていることを前提に可）。

#### Phase 0 完了後 → 次に実装すべきこと（Phase 1: 公開ブログ）

開発者に以下を提示する。

1. **記事の型と Supabase 取得**
   - Post 型（title, body, image_url, slug, published 等）を定義する（例: `lib/types.ts` や `app/` 内）。
   - Supabase クライアントで **公開済み（published = true）のみ** 一覧取得・slug で 1 件取得する関数またはコードを用意する。
2. **トップページ（一覧）**
   - `app/page.tsx` で公開済み記事を取得し、タイトル・サムネイル・日付・リンク等を一覧表示する。
3. **記事詳細ページ**
   - `app/posts/[slug]/page.tsx` を作成する。slug で 1 件取得し、存在しなければ 404。トップに画像 1 枚（image_url）と本文（body）を表示する。
4. **本文の表示**
   - `react-markdown` 等で Markdown をレンダリングする。**rehype-raw や生 HTML のそのまま表示は使わない**（XSS 対策）。

---

### Phase 1: 公開ブログ（閲覧側）

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 1a | 記事の型または取得が存在する | `lib/` や `app/` に Post 型定義または Supabase から取得するコードがある |
| 1b | トップページで一覧を表示している | `app/page.tsx` が公開済み記事（`published === true` 相当）を取得し、一覧表示している |
| 1c | 記事詳細ページがある | `app/posts/[slug]/page.tsx` が存在し、slug で 1 件取得して表示している |
| 1d | 詳細でトップ画像 1 枚と本文を表示している | 詳細ページで `image_url` と body（Markdown）を表示している |
| 1e | Markdown をレンダリングしている | `react-markdown` 等で本文を表示している（生の HTML をそのまま出していない） |

**説明**: 公開サイトで一覧・詳細が表示され、Markdown 表示と XSS を考慮した実装になっている。

**Gemini の具体的な確認（Phase 1）** — 以下をすべて満たしていること。

- [ ] **1-Q1** 記事取得は **Supabase クライアント**（`createClient` 等）を用いており、他 DB やローカルファイルからの取得ではない。
- [ ] **1-Q2** 一覧・詳細の取得で **`published === true`（または同等）でフィルタ**している。公開サイトに下書きが表示されない。
- [ ] **1-Q3** 詳細ページは **slug で 1 件取得**して表示している。存在しない slug のときは 404 または適切なエラー表示がある。
- [ ] **1-Q4** 本文表示に **`react-markdown` 等の Markdown レンダラ**を使用している。**`rehype-raw` や `dangerouslySetInnerHTML` で生 HTML をそのまま表示していない**（XSS 対策）。
- [ ] **1-Q5** トップ画像（`image_url`）と本文（body）の両方が詳細ページで表示されている。
- [ ] **1-Q6** 型定義（Post 等）に `published` が含まれるか、取得クエリで公開条件がかかっている。

#### Phase 1 完了後 → 次に実装すべきこと（Phase 2: 管理者画面の基盤）

開発者に以下を提示する。

1. **管理用ルート**
   - `app/admin/` 配下に `layout.tsx` と `page.tsx` を用意する。記事一覧・新規投稿への導線（リンクやタブ）を配置する。
2. **ログイン画面**
   - `app/admin/login/` にログインフォーム（パスワード入力・送信）を作成する。パスワードは **環境変数（例: ADMIN_PASSWORD）** と比較し、**ソースにハードコードしない**。
3. **認証の保持**
   - ログイン成功後に **署名付き Cookie** をセットする（署名用の秘密は環境変数、例: SESSION_SECRET）。middleware でその Cookie を検証する。
4. **middleware で /admin を保護**
   - `middleware.ts` で `/admin` へのアクセスをチェックし、未認証なら `/admin/login` へリダイレクトする。`/admin/login` 自体は除外する。

---

### Phase 2: 管理者画面の基盤

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 2a | 管理用ルートがある | `app/admin/` 配下に `layout.tsx` または `page.tsx` がある |
| 2b | ログイン画面がある | `app/admin/login/` にログインフォーム（パスワード送信）がある |
| 2c | 認証が Cookie 等で保持されている | ログイン成功後に Cookie をセットする、または署名付きセッションを扱うコードがある |
| 2d | middleware で /admin を保護している | `middleware.ts` が存在し、`/admin` へのアクセスを認証で制御している |
| 2e | 管理画面のレイアウトがある | 記事一覧や新規投稿への導線（リンクやタブ）が admin 配下にある |

**説明**: `/admin` にログインして入れること、未認証は弾かれること。

**Gemini の具体的な確認（Phase 2）** — 以下をすべて満たしていること。

- [ ] **2-Q1** 認証は **パスワードまたは署名付き Cookie / セッション**で行っている。認証情報は環境変数（例: `ADMIN_PASSWORD`）と比較しており、**値がソースにハードコードされていない**。
- [ ] **2-Q2** `middleware.ts` が **`/admin` 配下**を保護している。未認証時はログイン画面へリダイレクトするか 401/403 を返している（`/admin/login` は除外されている）。
- [ ] **2-Q3** ログイン成功後に **Cookie をセットする**（または署名付き Cookie を利用する）処理があり、その Cookie を middleware で検証している。
- [ ] **2-Q4** 管理用ルートは `app/admin/` 配下にあり、記事一覧や新規投稿への導線（リンク・ボタン）が存在する。
- [ ] **2-Q5** 認証に使う秘密（パスワード比較用・署名用）が **環境変数から読み込まれており**、リポジトリに含まれていない。

#### Phase 2 完了後 → 次に実装すべきこと（Phase 3: 記事の投稿・編集機能）

開発者に以下を提示する。

1. **新規投稿画面**
   - `app/admin/new/` にタイトル・本文（Markdown）・トップ画像入力のフォームと保存処理を用意する。
2. **画像アップロード**
   - API Route または Server Action で画像を受け取り、**Supabase Storage** にアップロードする。取得した **URL を記事の image_url に保存**する（管理認証済みのコンテキストでのみ実行可能にする）。
3. **記事の保存**
   - 新規・更新とも **Supabase の posts テーブル** に create / update する（ローカルファイルや他 DB は使わない）。
4. **管理用記事一覧**
   - 管理画面で **全記事**（下書き・公開両方）を一覧表示し、各行から編集・削除へ遷移できるようにする。
5. **編集・削除**
   - 編集ページ（例: `app/admin/[id]/edit/`）で既存記事を取得・表示し、更新する。削除ボタンと削除処理（Server Action または API）を用意する。

---

### Phase 3: 記事の投稿・編集機能

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 3a | 新規投稿画面がある | `app/admin/new/` にタイトル・本文・画像入力と保存処理がある |
| 3b | 画像を Supabase Storage にアップロードしている | API Route または Server Action で Storage にアップロードし、URL を返している |
| 3c | 記事を Supabase の posts に保存している | create/update が Supabase の posts テーブルに対して行われている（ファイル書き込みではない） |
| 3d | 管理用記事一覧がある | 全記事（下書き・公開両方）を一覧表示している |
| 3e | 編集・削除ができる | 編集ページ（例: `app/admin/[id]/edit/`）と削除処理がある |

**説明**: 管理画面から記事の作成・編集・削除・画像紐付けができる。

**Gemini の具体的な確認（Phase 3）** — 以下をすべて満たしていること。

- [ ] **3-Q1** 記事の **create / update は Supabase の posts テーブル**に対して行われている。ローカルファイルや他 DB への書き込みではない。
- [ ] **3-Q2** 画像アップロードは **Supabase Storage** を使用している。アップロード後に取得した URL を記事の `image_url` 等に保存している。
- [ ] **3-Q3** 管理用記事一覧は **published でフィルタせず全件**表示している（下書き・公開の両方）。
- [ ] **3-Q4** 編集画面で既存記事を取得・表示し、更新処理がある。削除処理（ボタン＋API/Server Action）が存在する。
- [ ] **3-Q5** 新規投稿・編集フォームに **タイトル・本文・画像**（少なくともタイトルと本文）の入力があり、送信で Supabase に保存される。
- [ ] **3-Q6** 画像アップロードや記事保存は **管理認証済みコンテキスト**（admin 配下の Server Action または API Route）で行われ、未認証で実行できない。

#### Phase 3 完了後 → 次に実装すべきこと（Phase 4: 公開状態・下書き）

開発者に以下を提示する。

1. **published の扱い**
   - 型・データモデルに **published**（boolean）が含まれるようにする。Supabase の posts に該当カラムがあればそれを使う。
2. **公開サイトは published のみ**
   - `app/page.tsx` と `app/posts/[slug]/page.tsx` の取得で **必ず published === true（または eq('published', true)）でフィルタ**し、下書きが表示されないようにする。
3. **管理一覧は全件**
   - 管理用記事一覧では **published でフィルタせず全件**表示する。
4. **下書き/公開の切り替え**
   - 管理画面（一覧または編集画面）で **下書き⇔公開を切り替えられる UI**（トグル・ボタン・チェックボックス等）を用意し、更新を Supabase の posts に反映する。

---

### Phase 4: 公開状態・下書き

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 4a | posts に published がある | データ取得や型に `published`（boolean 等）が含まれる |
| 4b | 公開サイトは published のみ表示 | 一覧・詳細の取得で `published === true`（または同等）でフィルタしている |
| 4c | 管理一覧は全件表示 | 管理用の一覧で `published` でフィルタせず全件取得している |
| 4d | 下書き/公開を切り替えられる | 管理画面で公開状態を変更できる UI または API がある |

**説明**: 下書きと公開が分離し、公開サイトには公開済みだけ表示される。

**Gemini の具体的な確認（Phase 4）** — 以下をすべて満たしていること。

- [ ] **4-Q1** データモデル・型に **`published`（boolean 等）** が含まれ、Supabase の posts に該当カラムがある（または取得時にマッピングされている）。
- [ ] **4-Q2** **公開サイト**（`app/page.tsx`, `app/posts/[slug]/page.tsx`）の取得では **必ず `published === true`（または同等）でフィルタ**している。
- [ ] **4-Q3** **管理用一覧**では **published でフィルタせず全件**表示している。
- [ ] **4-Q4** 管理画面で **下書き⇔公開の切り替え**ができる（トグル・ボタン・チェックボックス等）。更新は Supabase の posts に対して行っている。
- [ ] **4-Q5** 一覧・詳細の取得コードを再確認し、公開サイト側に `eq('published', true)` 等の条件が**確実に含まれている**こと。

#### Phase 4 完了後 → 次に実装すべきこと（Phase 5: 仕上げ・運用）

開発者に以下を提示する。

1. **フォームのバリデーション**
   - 投稿・編集フォームで **タイトル・本文の必須チェック** または形式チェックを行い、送信前にバリデーションする。
2. **エラー表示**
   - API / Server Action のエラーやフォームエラーを **ユーザーに表示**する（トースト・インラインメッセージ・フォーム下の表示等）。
3. **README / 環境変数の説明**
   - README に **起動方法**（`npm install`, `npm run dev`）を記載する。`.env.example` に **必要な環境変数名と用途**（NEXT_PUBLIC_SUPABASE_URL, ADMIN_PASSWORD 等）を書く。
4. **セキュリティの確認**
   - 本文表示で **rehype-raw や生 HTML の無害化なし表示をしていない**こと、`/admin` が middleware で保護されていること、秘密が環境変数で扱われていることを確認する。

---

### Phase 5: 仕上げ・運用

| ID | 確認内容 | 判定の目安 |
| -- | -------- | ---------- |
| 5a | フォームのバリデーションがある | 投稿フォームで必須や形式のチェックをしている |
| 5b | エラー表示がある | API やフォームのエラーをユーザーに伝えている |
| 5c | 環境変数・README に説明がある | README または .env.example に起動方法や変数の説明がある |
| 5d | セキュリティの考慮がある | XSS（Markdown の安全な表示）、管理者保護、環境変数の扱いのいずれかがコードやコメントで分かる |

**説明**: 運用を意識したバリデーション・エラー・ドキュメント・セキュリティが揃っている。

**Gemini の具体的な確認（Phase 5）** — 以下をすべて満たしていること。

- [ ] **5-Q1** 投稿フォームに **必須チェック**（タイトル・本文が空でない等）または形式チェックがあり、送信前にバリデーションしている。
- [ ] **5-Q2** API / Server Action のエラーやフォームエラーが **ユーザーに表示**されている（トースト・インラインメッセージ・alert 等）。
- [ ] **5-Q3** README または .env.example に **起動方法**（`npm install`, `npm run dev`）と **必要な環境変数名と説明**が記載されている。
- [ ] **5-Q4** **XSS 対策**: 本文表示に `react-markdown` を使い、**rehype-raw や生 HTML の無害化なし表示をしていない**。
- [ ] **5-Q5** **管理者保護**: `/admin` は middleware で保護され、認証に使う秘密は環境変数から読み込んでいる。
- [ ] **5-Q6** **環境変数**: 秘密情報がソースにハードコードされておらず、.env が .gitignore に含まれている。

#### Phase 5 完了後

- 全フェーズ完了。開発者に「チュートリアルお疲れさまでした。デプロイやカスタムドメインなど、発展課題に進んでください」と伝える。

---

## フェーズ一覧（TOC 用）

- **Phase 0**: 環境準備  
- **Phase 1**: 公開ブログ（閲覧側）  
- **Phase 2**: 管理者画面の基盤  
- **Phase 3**: 記事の投稿・編集機能  
- **Phase 4**: 公開状態・下書き  
- **Phase 5**: 仕上げ・運用  

現在の課題位置を表示するときは、例: `Phase 2: 管理者画面の基盤 📍（現在の課題）` のようにマークする。
