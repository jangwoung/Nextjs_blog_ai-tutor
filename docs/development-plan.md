# Next.js ブログ 開発プラン

## 概要

- 公開サイト: トップに画像1枚 + 本文テキストのシンプルなブログ
- 管理者画面: 別ルート（例: `/admin`）で記事の投稿・管理

---

## 本プランの前提（講義向け）

- **デプロイ先**: Cloudflare（Pages / Workers）
- **データ・画像**: Supabase（DB + Storage）に統一

Cloudflare の実行環境では **サーバー側のファイル書き込み（`fs.writeFile`）ができない**ため、管理画面からの投稿を永続化するには **DB と Storage が必須**です。ローカルファイルや SQLite は永続化・同時更新で破綻しやすいため、講義では最初から Supabase を採用し「本番で動く」体験を得られるようにします。

※ 「ファイルで手軽に」やりたい場合は **Vercel / Node ランタイム** 前提の別プランになります。

---

## 開発前に決めておきたいこと（必要情報）

### 1. データの保存先

| 選択肢 | 説明 |
| ------ | ---- |
| **Supabase** | クラウドDB。講義ではこちらを採用（Cloudflare と相性が良い） |

### 2. 管理者認証

| 選択肢 | 説明 |
| ------ | ---- |
| **簡易パスワード + 署名付きCookie** | 1つのパスワードを環境変数で管理し、ログイン済みを Cookie で表現。講義ではこちらを推奨 |
| **NextAuth.js（Auth.js）** | 発展課題。Cloudflare では Edge 対応・アダプタの考慮が必要 |

### 3. 画像の保存先

| 選択肢 | 説明 |
| ------ | ---- |
| **Supabase Storage** | アップロードした画像を Storage に保存し、取得した URL を DB に保存（Cloudflare では `public/` への永続化は不可） |

### 4. デプロイ先

- **Cloudflare**（Pages / Workers）。Edge 実行の制約（fs 書き込み不可など）を前提に設計する。

### 5. ブログ記事の形式

- **Markdown** で本文を書く（DB に文字列で保存）

---

## 開発ステップ（フェーズ分け）

### フェーズ 0: 環境準備

1. Next.js プロジェクトの作成（App Router 推奨）
2. 必要パッケージの選定・インストール
   - スタイリング: Tailwind CSS
   - データ: Supabase（クライアント + サーバー用）
   - 認証: 簡易パスワード + 署名付き Cookie（発展で Auth.js を検討）
3. 環境変数の設計（`.env.example` の作成）
   - 例: `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`（または `ANON_KEY`）, `ADMIN_PASSWORD`, `SESSION_SECRET`（Cookie 署名用）など
4. Cloudflare 前提の制約を把握
   - 管理画面から投稿する＝永続化が必要 → DB / Storage が必須
   - Edge 実行では `fs.writeFile` 等のサーバー側ファイル書き込みは不可（できても永続化されない）

**成果物**: 起動できる Next.js アプリ、Supabase プロジェクトの準備、ディレクトリ構成方針

---

### フェーズ 1: 公開ブログ（閲覧側）

1. **データモデル・取得の用意**
   - 記事の型定義（タイトル、本文、トップ画像URL、公開日、slug 等）
   - **Supabase** から一覧取得・1件取得（公開済み `published = true` のみ）
2. **トップページ（一覧）**
   - 記事一覧を表示（タイトル・サムネイル・日付・抜粋など）
3. **記事詳細ページ**
   - ルート例: `/posts/[slug]`
   - トップに画像1枚 + 本文（Markdown をレンダリング）
4. **レイアウト・ナビ**
   - 共通レイアウト、ヘッダー、フッター（必要なら）
5. **XSS 対策（講義で必ず触れる）**
   - Markdown を HTML にする際、**危険な HTML をそのまま通さない**方針にする
   - `react-markdown` を使う場合: **`rehype-raw` は安易に ON にしない**（講義では OFF 推奨）。管理者だけが書く前提でも、癖として危ないのでここで押さえる

**成果物**: 一覧・詳細が表示できる公開サイト

---

### フェーズ 2: 管理者画面の基盤

1. **管理者ルートの作成**
   - 例: `/admin` 以下にレイアウトとページを配置
2. **認証の導入（方式の違いを明確に）**
   - **簡易パスワード + 署名付き Cookie** の場合:
     - 「ログイン済み」を **署名付き Cookie** で保持する（ただの「パスワード一致したら画面出す」だと、ページ更新で戻る・直リンクで入れる等が起きる）
     - **管理 API を叩けるのはサーバー側のみ**にし、`middleware` で `/admin` を保護する
   - **NextAuth（Auth.js）** の場合: Cloudflare では Edge 対応・アダプタの考慮が絡むため、講義では発展課題とする
   - 未認証時は `/admin` をログイン画面にリダイレクト
3. **管理画面のレイアウト**
   - サイドバー or タブで「記事一覧」「新規投稿」などに遷移できるようにする

**成果物**: `/admin` にログインできる管理画面の土台（署名付き Cookie + middleware で保護）

---

### フェーズ 3: 記事の投稿・編集機能

1. **新規投稿画面**
   - タイトル、本文（Markdown）、トップ画像（アップロード）
   - プレビュー（任意）
2. **画像アップロード**
   - API Route（サーバー側）で受け取り、**Supabase Storage** にアップロード
   - 取得した **URL を DB に保存**（Cloudflare では `public/` への永続化は不可）
3. **記事の保存**
   - **Supabase の posts テーブル**に create / update（ファイル書き込み・SQLite は使わない）
4. **記事一覧（管理用）**
   - **全記事**（下書き・公開どちらも）の一覧、編集・削除へのリンク
5. **編集・削除**
   - 既存記事の更新・削除を Supabase 経由で実行

**成果物**: 管理画面から記事の作成・編集・削除ができる状態（DB + Storage 一本化）

---

### フェーズ 4: 公開状態・下書き

1. **下書きと公開の区別**
   - Supabase の posts に `published: boolean` や `status: 'draft' | 'published'` を追加
2. **公開サイトでは公開済みのみ表示**
   - **公開一覧・詳細**: 取得時に `published === true` のみを返す
3. **管理画面では全件表示**
   - **管理一覧**: 下書き・公開を **全件** 表示する（`published` でフィルタしない）
   - 下書き一覧、公開ボタン、公開日時の表示・編集（任意）

**成果物**: 下書きを保存でき、公開サイトには公開済みだけ表示され、管理側では全件見える状態

---

### フェーズ 5: 仕上げ・運用

1. **バリデーション・エラーハンドリング**
   - 投稿フォームの必須項目・形式チェック
   - API のエラー応答と画面表示
2. **セキュリティ確認（講義で触れる粒度）**
   - **XSS**: Markdown/HTML 表示があるため **必須**。サニタイズ・`rehype-raw` を安易に使わない方針を確認
   - **CSRF**: フォーム投稿があるなら触れる。難しければ「SameSite cookie / POST のみ」程度でよい
   - **環境変数**: `NEXT_PUBLIC_`（クライアントに露出）とサーバー専用の違いは **講義で超重要**
   - 管理者ルートの保護（middleware + 署名付き Cookie）の確認
3. **テスト**
   - 重要フロー（一覧表示、詳細表示、投稿、編集）のテスト
4. **README・環境変数ドキュメント**
   - 起動方法、`.env` の説明、Cloudflare デプロイの前提

**成果物**: そのままデプロイ・運用できる状態

---

## 技術スタック（講義用・矛盾が少ない組み合わせ）

| 項目 | 採用案 |
| ---- | ------ |
| FW | Next.js 14+ (App Router) |
| 言語 | TypeScript |
| スタイル | Tailwind CSS |
| データ | Supabase（DB）。記事は posts テーブルに保存 |
| 画像 | Supabase Storage。アップロード後は URL を DB に保存 |
| 本文 | Markdown（DB に文字列で保存）+ `react-markdown` |
| 認証 | 簡易パスワード + 署名付き Cookie（発展で Auth.js） |
| デプロイ | Cloudflare（Pages / Workers） |
